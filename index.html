<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Страховая справедливость</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --tg-theme-bg-color: var(--tg-theme-bg-color, #ffffff);
            --tg-theme-text-color: var(--tg-theme-text-color, #222222);
            --tg-theme-hint-color: var(--tg-theme-hint-color, #999999);
            --tg-theme-link-color: var(--tg-theme-link-color, #007aff);
            --tg-theme-button-color: var(--tg-theme-button-color, #007aff);
            --tg-theme-button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --tg-theme-secondary-bg-color: var(--tg-theme-secondary-bg-color, #f3f4f6);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0; padding: 0;
            overscroll-behavior: none;
        }
        
        .page-container {
            position: relative; width: 100vw; height: 100vh; overflow: hidden;
        }

        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 20px; padding-bottom: 90px;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto; background-color: var(--tg-theme-bg-color);
            box-sizing: border-box;
            visibility: hidden;
        }

        .page.active { visibility: visible; }
        .page.left { transform: translateX(-100%); }
        .page.center { transform: translateX(0); }
        .page.right { transform: translateX(100%); }
        
        .service-card {
            background-color: var(--tg-theme-secondary-bg-color);
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .service-card.selected {
            border-color: var(--tg-theme-button-color);
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 122, 255, 0.1), 0 4px 6px -2px rgba(0, 122, 255, 0.05);
        }
        .service-card .icon-container {
            background-color: rgba(0, 122, 255, 0.1);
            color: var(--tg-theme-link-color);
        }

        .form-input {
            width: 100%; padding: 12px 16px; border-radius: 12px;
            border: 2px solid var(--tg-theme-secondary-bg-color);
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color); font-size: 16px;
            transition: border-color 0.2s;
        }
        .form-input::placeholder { color: var(--tg-theme-hint-color); }
        .form-input:focus { outline: none; border-color: var(--tg-theme-button-color); }
        .form-input.invalid { border-color: #ef4444; }
        
        .progress-bar {
            background-color: var(--tg-theme-secondary-bg-color);
            overflow: hidden;
        }
        .progress-bar-fill {
            background-color: var(--tg-theme-button-color);
            transition: width 0.4s ease;
        }
    </style>
</head>
<body>

<div class="page-container">
    <!-- СТРАНИЦА 1: ВЫБОР ПРОБЛЕМЫ -->
    <div id="page-problems" class="page active center">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold">Страховая справедливость</h1>
            <p class="mt-2 text-md" style="color: var(--tg-theme-hint-color);">Выберите, что у вас случилось</p>
             <p class="text-xs mt-2" style="color: var(--tg-theme-hint-color);">Версия 2.1</p>
        </header>
        <div class="progress-bar w-full h-2 rounded-full mb-6">
            <div class="progress-bar-fill h-full rounded-full" style="width: 25%;"></div>
        </div>
        <div id="services-grid" class="grid grid-cols-2 gap-4"></div>
    </div>

    <!-- НОВАЯ СТРАНИЦА: ДЕТАЛИ УСЛУГИ -->
    <div id="page-details" class="page right">
         <div id="details-content"></div>
    </div>

    <!-- СТРАНИЦА 2: КОНТАКТНЫЕ ДАННЫЕ -->
    <div id="page-contacts" class="page right">
        <h1 class="text-2xl font-bold mb-2">Контактные данные</h1>
        <p class="mb-6" style="color: var(--tg-theme-hint-color);">Чтобы мы могли с вами связаться</p>
        <div class="progress-bar w-full h-2 rounded-full mb-6">
            <div class="progress-bar-fill h-full rounded-full" style="width: 50%;"></div>
        </div>
        <div class="space-y-4">
            <div>
                <label for="name" class="font-medium text-sm ml-1 mb-1 block">Ваше имя</label>
                <input type="text" id="name" class="form-input" placeholder="Иван Иванов">
            </div>
            <div>
                <label for="phone" class="font-medium text-sm ml-1 mb-1 block">Номер телефона</label>
                <input type="tel" id="phone" class="form-input" placeholder="+7 (999) 123-45-67">
            </div>
        </div>
    </div>

    <!-- СТРАНИЦА 3: ОПИСАНИЕ -->
    <div id="page-description" class="page right">
        <h1 class="text-2xl font-bold mb-2">Описание ситуации</h1>
        <p class="mb-6" style="color: var(--tg-theme-hint-color);">Опишите вашу проблему кратко</p>
        <div class="progress-bar w-full h-2 rounded-full mb-6">
            <div class="progress-bar-fill h-full rounded-full" style="width: 75%;"></div>
        </div>
        <textarea id="description" class="form-input" rows="6" placeholder="Например: Страховая отказала в выплате после ДТП..."></textarea>
    </div>

    <!-- СТРАНИЦА 4: ПОДТВЕРЖДЕНИЕ -->
    <div id="page-summary" class="page right">
        <h1 class="text-2xl font-bold mb-2">Проверьте заявку</h1>
        <p class="mb-6" style="color: var(--tg-theme-hint-color);">Все данные верны?</p>
        <div class="progress-bar w-full h-2 rounded-full mb-6">
            <div class="progress-bar-fill h-full rounded-full" style="width: 100%;"></div>
        </div>
        <div id="summary-container" class="space-y-4"></div>
    </div>

    <!-- СТРАНИЦА 5: УСПЕХ -->
    <div id="page-success" class="page right flex flex-col items-center justify-center text-center">
        <div class="w-24 h-24 rounded-full flex items-center justify-center mb-6" style="background-color: #34c7591a;">
            <i data-lucide="check" class="w-12 h-12" style="color: #34c759;"></i>
        </div>
        <h1 class="text-2xl font-bold mb-2">Заявка отправлена!</h1>
        <p style="color: var(--tg-theme-hint-color);" class="mb-6">Наш юрист скоро свяжется с вами.</p>
        <div id="success-actions" class="w-full"></div>
        <button id="close-app-btn" class="mt-4 font-semibold py-3 px-6 rounded-lg w-full" style="color: var(--tg-theme-link-color);">Закрыть</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;

    const services = [
        { 
            id: 'denial', title: 'Отказ в выплате', icon: 'shield-off',
            details: 'Страховые компании часто ищут формальные поводы для отказа. Мы знаем все уловки и поможем доказать ваше право на выплату.',
            caseLink: 'https://strahovayasprav.ru/services/denial-of-payment/' 
        },
        { 
            id: 'underpayment', title: 'Занижение выплаты', icon: 'trending-down',
            details: 'Самая частая проблема. Мы организуем независимую экспертизу, которая установит реальную сумму ущерба, и взыщем разницу со страховой.',
            caseLink: 'https://strahovayasprav.ru/services/underpayment/' 
        },
        { 
            id: 'delay', title: 'Затягивание сроков', icon: 'hourglass',
            details: 'По закону у страховой есть 20 дней на выплату. Если сроки нарушены, вы имеете право на неустойку (1% от суммы за каждый день просрочки).',
            caseLink: 'https://strahovayasprav.ru/services/delay-of-terms/'
        },
        { 
            id: 'uts', title: 'Взыскание УТС', icon: 'receipt',
            details: 'Утрата товарной стоимости (УТС) – это уменьшение рыночной цены авто после ремонта. Ее почти никогда не выплачивают добровольно.',
            caseLink: 'https://strahovayasprav.ru/services/uts-recovery/'
        },
        { 
            id: 'culprit', title: 'Спор с виновником', icon: 'users',
            details: 'Если лимита по ОСАГО (400 тыс. руб.) не хватило на ремонт, разницу можно и нужно взыскивать напрямую с виновника ДТП.',
            caseLink: 'https://strahovayasprav.ru/services/dispute-with-the-culprit/'
        },
        { 
            id: 'other', title: 'Другая проблема', icon: 'help-circle',
            details: 'Если вы не нашли свою проблему в списке, подробно опишите ее на следующем шаге, и мы обязательно разберемся и поможем.',
            caseLink: 'https://strahovayasprav.ru/blog/'
        }
    ];
    let state = {
        currentPage: 'problems',
        previousPage: null,
        formData: {
            problems: new Set(),
            name: '', phone: '', description: ''
        }
    };
    const pageOrder = ['problems', 'contacts', 'description', 'summary'];

    const pages = {
        problems: document.getElementById('page-problems'),
        details: document.getElementById('page-details'),
        contacts: document.getElementById('page-contacts'),
        description: document.getElementById('page-description'),
        summary: document.getElementById('page-summary'),
        success: document.getElementById('page-success')
    };

    document.addEventListener('DOMContentLoaded', () => {
        try {
            tg.ready();
            tg.expand();
            
            if (tg.initDataUnsafe?.user) {
                const user = tg.initDataUnsafe.user;
                state.formData.name = `${user.first_name || ''} ${user.last_name || ''}`.trim();
                document.getElementById('name').value = state.formData.name;
            }

            renderServiceCards();
            updateUI();
            lucide.createIcons();

            document.getElementById('services-grid').addEventListener('click', handleServiceClick);
            document.getElementById('close-app-btn').addEventListener('click', () => tg.close());
            Object.values(document.querySelectorAll('.form-input')).forEach(input => input.addEventListener('input', handleInputChange));
            tg.MainButton.onClick(handleMainButtonClick);
            tg.onEvent('backButtonClicked', handleBackButtonClick);
        } catch (e) {
            console.error("Initialization failed:", e);
        }
    });
    
    function navigate(targetPage, direction = 'forward') {
        const currentElem = pages[state.currentPage];
        const targetElem = pages[targetPage];
        
        if (!currentElem || !targetElem) {
            console.error(`Navigation error: page not found. Target: ${targetPage}`);
            return;
        }

        Object.values(pages).forEach(p => {
            p.classList.remove('center', 'left', 'right', 'active');
        });
        
        if (direction === 'forward') {
            currentElem.classList.add('left');
        } else {
            currentElem.classList.add('right');
        }
        targetElem.classList.add('center', 'active');

        state.previousPage = state.currentPage;
        state.currentPage = targetPage;
        updateUI();
    }

    function handleBackButtonClick() {
        if (state.currentPage === 'details') {
            navigate(state.previousPage || 'problems', 'backward');
        } else {
            const currentIndex = pageOrder.indexOf(state.currentPage);
            if (currentIndex > 0) {
                navigate(pageOrder[currentIndex - 1], 'backward');
            }
        }
    }

    function handleServiceClick(event) {
        const card = event.target.closest('.service-card');
        if (!card) return;
        
        const serviceId = card.dataset.serviceId;
        const infoButton = event.target.closest('.info-btn');

        if (infoButton) {
            tg.HapticFeedback.impactOccurred('light');
            renderDetailsPage(serviceId);
            navigate('details');
        } else {
            state.formData.problems.has(serviceId) ? state.formData.problems.delete(serviceId) : state.formData.problems.add(serviceId);
            tg.HapticFeedback.selectionChanged();
            card.classList.toggle('selected');
        }
        updateUI();
    }
    
    function handleInputChange(event) {
        const { id, value } = event.target;
        state.formData[id] = id === 'phone' ? formatPhoneNumber(value) : value;
        if (id === 'phone') event.target.value = state.formData.phone;
        updateUI();
    }

    function handleMainButtonClick() {
        if (!validateCurrentPage()) {
            tg.HapticFeedback.notificationOccurred('error');
            return;
        }

        const currentPage = state.currentPage;
        const currentIndex = pageOrder.indexOf(currentPage);

        if (currentIndex !== -1 && currentIndex < pageOrder.length - 1) {
            navigate(pageOrder[currentIndex + 1]);
        } else if (currentPage === 'summary') {
            sendData();
        } else if (currentPage === 'details') {
            handleBackButtonClick();
        }
    }

    function sendData() {
        tg.MainButton.showProgress();
        const { problems, ...rest } = state.formData;
        const dataToSend = { ...rest, problems: Array.from(problems).map(id => services.find(s => s.id === id).title) };
        tg.sendData(JSON.stringify(dataToSend));
        renderSuccessActions();
        setTimeout(() => navigate('success'), 500);
    }
    
    function updateUI() {
        tg.BackButton.isVisible = state.currentPage !== 'problems';
        
        let mb = { is_visible: false };
        if (state.currentPage === 'details') {
            mb = { text: 'Назад к выбору', is_visible: true, is_active: true };
        } else if (pageOrder.includes(state.currentPage)) {
            mb = {
                text: state.currentPage === 'summary' ? 'Отправить заявку' : 'Далее',
                is_visible: true,
                is_active: validateCurrentPage()
            };
        }
        tg.MainButton.setParams(mb);

        if (state.currentPage === 'summary') renderSummary();
        lucide.createIcons();
    }

    function renderServiceCards() {
        const grid = document.getElementById('services-grid');
        grid.innerHTML = services.map(service => `
            <div class="service-card rounded-xl p-3 cursor-pointer relative" data-service-id="${service.id}">
                <div class="absolute top-1 right-1 info-btn p-2 rounded-full z-10">
                    <i data-lucide="info" class="w-4 h-4" style="color: var(--tg-theme-hint-color);"></i>
                </div>
                <div class="flex-grow flex flex-col items-center text-center pt-2">
                    <div class="icon-container w-12 h-12 rounded-full flex items-center justify-center mb-2">
                        <i data-lucide="${service.icon}" class="w-6 h-6"></i>
                    </div>
                    <span class="font-semibold text-sm">${service.title}</span>
                </div>
            </div>
        `).join('');
    }

    function renderDetailsPage(serviceId) {
        const service = services.find(s => s.id === serviceId);
        document.getElementById('details-content').innerHTML = `
            <div class="flex items-center mb-4">
                <div class="icon-container w-12 h-12 rounded-full flex items-center justify-center mr-4">
                    <i data-lucide="${service.icon}" class="w-6 h-6"></i>
                </div>
                <h1 class="text-2xl font-bold">${service.title}</h1>
            </div>
            <p class="text-md" style="color: var(--tg-theme-text-color);">${service.details}</p>
        `;
    }
    
    function renderSuccessActions() {
        const container = document.getElementById('success-actions');
        const problemId = Array.from(state.formData.problems)[0] || 'other';
        const service = services.find(s => s.id === problemId);
        container.innerHTML = `
            <button id="view-cases-btn" class="font-bold py-3 px-6 rounded-lg w-full text-white" style="background-color: var(--tg-theme-button-color);">
                Посмотреть кейсы по этой проблеме
            </button>
        `;
        document.getElementById('view-cases-btn').onclick = () => tg.openLink(service.caseLink);
    }
    
    function renderSummary() {
        const container = document.getElementById('summary-container');
        const { problems, name, phone, description } = state.formData;
        const problemTitles = Array.from(problems).map(id => services.find(s => s.id === id).title);
        container.innerHTML = `
            <div class="p-4 rounded-lg bg-[var(--tg-theme-secondary-bg-color)]"><h3 class="font-bold mb-2">Проблема</h3><p>${problemTitles.join(', ') || 'Не указана'}</p></div>
            <div class="p-4 rounded-lg bg-[var(--tg-theme-secondary-bg-color)]"><h3 class="font-bold mb-2">Контактные данные</h3><p>Имя: ${name}</p><p>Телефон: ${phone}</p></div>
            <div class="p-4 rounded-lg bg-[var(--tg-theme-secondary-bg-color)]"><h3 class="font-bold mb-2">Описание</h3><p class="whitespace-pre-wrap">${description || 'Не указано'}</p></div>`;
    }

    function validateCurrentPage() {
        if (state.currentPage === 'problems') return state.formData.problems.size > 0;
        if (state.currentPage === 'contacts') {
            const isNameValid = state.formData.name.trim().length > 1;
            const isPhoneValid = state.formData.phone.replace(/\D/g, '').length >= 11;
            document.getElementById('name').classList.toggle('invalid', !isNameValid);
            document.getElementById('phone').classList.toggle('invalid', !isPhoneValid);
            return isNameValid && isPhoneValid;
        }
        return true;
    }

    function formatPhoneNumber(value) {
        const x = value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
        if (!x) return '';
        return !x[2] ? (x[1] ? '+7' : '') : '+7 (' + x[2] + (x[3] ? ') ' + x[3] : '') + (x[4] ? '-' + x[4] : '') + (x[5] ? '-' + x[5] : '');
    }
</script>
</body>
</html>
